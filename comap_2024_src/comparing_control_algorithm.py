import numpy as np

from hydrologic.great_lake import GreatLake
from hydrologic.get_statistic import get_stat, get_NBS_stat
from hydrologic.rating_curve import get_rating_curve

from cybernetic.mpc import MpcController

import matplotlib.pyplot as plt

wl_2017 = [74.485, 74.551, 74.555, 74.473, 74.497, 74.542, 74.554, 74.551, 74.564, 74.597, 74.569, 74.603, 74.599, 74.633, 74.629, 74.629, 74.691, 74.663, 74.679, 74.712, 74.706, 74.734, 74.754, 74.716, 74.724, 74.713, 74.683, 74.708, 74.733, 74.762, 74.786, 74.743, 74.747, 74.734, 74.746, 74.737, 74.787, 74.835, 74.775, 74.789, 74.814, 74.821, 74.838, 74.814, 74.85, 74.834, 74.836, 74.869, 74.85, 74.848, 74.878, 74.891, 74.885, 74.883, 74.92, 74.902, 74.898, 74.919, 74.955, 74.951, 74.924, 74.967, 74.983, 75.004, 75.006, 75.011, 74.989, 74.993, 74.989, 75.012, 75.009, 75.041, 75.031, 74.995, 75.006, 75.036, 75.077, 75.047, 75.047, 75.035, 75.041, 75.054, 75.056, 75.071, 75.109, 75.076, 75.076, 75.087, 75.118, 75.148, 75.117, 75.122, 75.167, 75.155, 75.187, 75.234, 75.256, 75.277, 75.321, 75.342, 75.355, 75.349, 75.364, 75.387, 75.398, 75.391, 75.404, 75.429, 75.44, 75.475, 75.471, 75.478, 75.499, 75.524, 75.539, 75.539, 75.543, 75.541, 75.526, 75.58, 75.569, 75.676, 75.627, 75.649, 75.723, 75.778, 75.818, 75.818, 75.817, 75.828, 75.844, 75.848, 75.862, 75.882, 75.867, 75.888, 75.905, 75.941, 75.896, 75.901, 75.909, 75.906, 75.896, 75.903, 75.938, 75.909, 75.909, 75.914, 75.908, 75.917, 75.91, 75.886, 75.883, 75.874, 75.892, 75.871, 75.885, 75.873, 75.869, 75.863, 75.87, 75.871, 75.861, 75.836, 75.837, 75.829, 75.823, 75.824, 75.833, 75.806, 75.816, 75.795, 75.799, 75.822, 75.822, 75.849, 75.835, 75.825, 75.81, 75.821, 75.813, 75.807, 75.8, 75.789, 75.781, 75.779, 75.769, 75.758, 75.756, 75.759, 75.746, 75.73, 75.73, 75.754, 75.73, 75.723, 75.731, 75.732, 75.721, 75.708, 75.701, 75.692, 75.689, 75.694, 75.683, 75.692, 75.685, 75.671, 75.675, 75.654, 75.64, 75.619, 75.607, 75.598, 75.585, 75.58, 75.645, 75.555, 75.538, 75.521, 75.52, 75.517, 75.501, 75.488, 75.48, 75.473, 75.453, 75.442, 75.449, 75.429, 75.422, 75.413, 75.4, 75.382, 75.364, 75.353, 75.333, 75.319, 75.318, 75.307, 75.293, 75.273, 75.273, 75.258, 75.255, 75.223, 75.215, 75.198, 75.199, 75.175, 75.173, 75.152, 75.145, 75.139, 75.128, 75.124, 75.108, 75.106, 75.097, 75.09, 75.087, 75.081, 75.071, 75.066, 75.056, 75.045, 75.031, 75.025, 75.017, 74.999, 74.984, 74.997, 74.971, 74.948, 74.949, 74.935, 74.921, 74.911, 74.908, 74.906, 74.887, 74.935, 74.94, 74.97, 74.965, 74.966, 74.952, 74.93, 74.92, 74.89, 74.883, 74.857, 74.855, 74.855, 74.853, 74.861, 74.851, 74.844, 74.822, 74.832, 74.801, 74.819, 74.781, 74.822, 74.863, 74.863, 74.865, 74.914, 74.902, 74.897, 74.925, 74.915, 74.896, 74.9, 74.917, 74.904, 74.902, 74.902, 74.907, 74.858, 74.885, 74.904, 74.86, 74.873, 74.88, 74.874, 74.877, 74.878, 74.865, 74.839, 74.868, 74.878, 74.849, 74.861, 74.856, 74.855, 74.852, 74.872, 74.835, 74.799, 74.811, 74.801, 74.823, 74.785, 74.831, 74.802, 74.797, 74.793, 74.786, 74.767, 74.803, 74.78, 74.75, 74.752, 74.787, 74.813, 74.766, 74.794, 74.713, 74.72, 74.769, 74.771, 74.778, 74.778, 74.78]


ontario_wl1 = [74.49975847851776, 74.511975381597, 74.51609073828755, 74.5128490637592, 74.51568472940936, 74.52304725209966, 74.53395760515792, 74.55891495838098, 74.58569360805667, 74.60026452492122, 74.61710495331617, 74.62398800389133, 74.63415534645009, 74.64798830050798, 
74.6572787540287, 74.67075971803922, 74.67926087144684, 74.69655562512975, 74.71038211804441, 74.71368987919917, 74.70011034073265, 74.69652090481917, 74.69432137864406, 74.69761072314215, 74.69911480190959, 74.70156599421087, 74.69846215138345, 74.70170067293873, 74.70030503327663, 74.70928954696909, 74.71662345622114, 74.72201386303924, 74.718043036848, 74.71332187320017, 74.71692284562563, 74.72157302275659, 74.73735228296698, 74.75997123851917, 74.77457401924421, 74.7727527288815, 74.77549569600615, 74.76892340979072, 74.764181173709, 74.77244377123509, 74.77835356781068, 74.78782918794934, 74.79640688955156, 74.79639549445106, 74.7946104307939, 74.79307751335088, 74.78450787947561, 74.78361761675617, 
74.79241119874003, 74.80073364122164, 74.81470693699029, 74.83025747036527, 74.83677529174628, 74.83171635013838, 74.83748778189069, 74.8451669663008, 74.8519187930946, 74.84847057135006, 74.85055576917625, 74.85870692209691, 74.8587472397067, 74.85213417350201, 74.85198257636104, 74.85135483536527, 74.85417625580227, 74.85938620448842, 74.85562421430411, 74.86381622487336, 74.85486792381057, 74.85335412446518, 74.85169600857394, 74.84720282119392, 74.84814343886242, 74.86868175120037, 74.89050166462424, 74.90872379717183, 74.92642610614146, 74.93491901643395, 74.95536062800343, 74.96334566040142, 74.96927010498254, 74.96703774970898, 74.97403284150843, 74.99192987825714, 75.00533116326383, 75.01328389531355, 75.01068039167579, 75.00003040291418, 74.9845906834159, 74.96915214916196, 74.9752059862606, 75.01110563220355, 75.0203579329977, 75.01654581143944, 75.0191285099209, 75.00868936615923, 74.99868186764678, 74.98014029017548, 74.97098794823978, 74.98170249546865, 74.9925296540015, 75.01533666567488, 75.02340572398613, 75.0522914589862, 75.07575725849277, 75.1169396218833, 75.13206013574576, 75.11531928988605, 75.09907283074868, 75.11398731779705, 75.12562488316267, 75.1128787923562, 75.10150837177385, 75.10548072405972, 75.11468956879402, 75.13440450129039, 75.15664273225525, 75.17405681237638, 75.19393678730079, 75.20509007216864, 75.21107442766815, 75.1986646537477, 75.17882236196384, 75.17719461305823, 75.19501400018628, 75.19801206721576, 75.1884283506711, 75.18055893368017, 75.1917575805556, 75.2056589088749, 75.21193876241497, 75.21241553557498, 75.20805235209558, 75.20696601919151, 75.19328585567465, 75.18877187004603, 75.19255935909786, 75.1907702377257, 75.18806351830264, 75.1829215843763, 75.19669875120142, 75.19777185550262, 75.19867576254245, 75.21186346207925, 75.21064543916809, 75.22240485736314, 75.23338430877756, 75.23537344054907, 75.23426534607239, 75.2305618181122, 75.23408109235334, 75.23173179074894, 75.22947242752844, 75.24057937325975, 75.24250530879813, 75.25178263015329, 75.25962037975818, 75.2561358783304, 75.24946444006936, 75.24666468196088, 75.23998674820763, 75.24127581379386, 75.24888761968184, 75.24577054975617, 75.23285398002413, 75.22409715197614, 75.21352744092846, 75.20590574584168, 75.20966267738702, 75.22618187133247, 75.23326930614542, 75.23304205709175, 75.2355617274947, 75.23309167197593, 75.22418100006604, 75.22796908331343, 75.22646888984166, 
75.22230348176271, 75.22179278010242, 75.2191282811537, 75.21693167695092, 75.21167253473304, 75.20776682077354, 75.20694128990812, 75.20821299152755, 75.21382618751359, 75.21731746554751, 75.20936135754101, 75.20410081530706, 75.1900369508644, 75.16607204847101, 75.1528331008087, 75.1482980808711, 75.13727596233772, 75.11746560870894, 75.10729818838479, 75.09985481995515, 75.08885402395784, 75.08537346091265, 75.08565237539048, 75.08010848022866, 75.06758527294713, 75.05281240100291, 75.03734943594714, 75.03672404004821, 75.03931085808387, 75.0292148037564, 75.01341420993477, 74.99609885961878, 74.9813284525117, 74.97136545888087, 74.96091059073795, 74.95030248530517, 74.94755893633652, 74.94420816373965, 74.93804425778353, 74.93299166052171, 74.92466146843745, 74.91124312085542, 74.89825772077413, 74.89368576538058, 74.8911908986992, 74.8909659109678, 74.88604241973034, 74.8773339930669, 74.86799270691348, 74.85764272469324, 74.85280566872794, 74.85191689309427, 74.85128096758785, 74.85157979376358, 74.84300564064877, 74.83787708982749, 74.8367185252079, 74.83960846541058, 74.83792252198943, 74.832761395687, 74.82289484598168, 74.81515496302667, 74.80512727652024, 74.79427454110228, 74.78442672311743, 74.77917525907634, 74.77780661730228, 74.77803567098779, 74.7816603208225, 74.78091907999637, 74.7806304638461, 74.78494346712267, 74.78493990475984, 74.78523469931602, 74.78245560678903, 74.7818849596598, 74.76971980266413, 74.75673183270052, 74.75088307424696, 74.74069222479059, 74.73089679415895, 74.72095914693124, 74.7197315671353, 74.72037580989593, 74.72429548077497, 74.72069538998825, 74.71489647005741, 74.70865159904069, 74.70803172175829, 74.70778053420267, 74.70263787221427, 74.69450739079694, 74.68763720646102, 74.68353320040094, 74.68076106824964, 74.67866539549064, 74.67042035268067, 74.66675645912947, 74.66335071958248, 74.67120099578622, 74.6708983708455, 74.66383681995852, 74.66084419233232, 74.65308675577091, 74.6459459976068, 74.64553459435434, 74.63832277379282, 74.6340115716833, 74.63052139118429, 74.62161853078715, 74.61751001791815, 74.6130520184622, 74.6057863191536, 74.60281176912092, 
74.60805601639969, 74.61031700047258, 74.61178022024755, 74.60974266250709, 74.61229572209098, 74.6144209254977, 74.60951097710944, 74.61160115548154, 74.62468279181859, 74.63377611417938, 74.6327202532307, 74.62686251629127, 74.62724908120389, 74.62264160017101, 74.61776031435797, 74.61354915591701, 74.60771730964424, 74.60164320778688, 74.59265927072566, 74.57976223025628, 74.56773928327695, 74.56072212599318, 74.55300476105907, 74.54939422850784, 74.54965504535312, 74.55057206931761, 74.55076547129555, 74.54820103337592, 74.53855693031997, 74.52850080840156, 74.52057799908498, 74.5145827627038, 74.51529126383431, 74.5175839876661, 74.51621314045481, 74.5121900536714, 74.50943517342546, 74.50961735864601, 74.51103267304411, 74.50829155375139, 74.5095668636943, 74.51384334582791, 74.52129372371371, 74.52807296765447, 74.53584735050572, 74.54470464309546, 74.55267780693211, 74.55254289974037, 74.55357895044637, 74.551974017714, 74.55023810131523, 74.5466879191307, 74.54898731976596, 74.5535978426564, 74.55299440389275, 74.54851902952237, 74.54487980056106, 74.54883662131485, 74.55061924309588, 74.55305326750748, 74.55799763173262, 74.55751578425163, 74.55970231476202, 74.56235032296293, 74.56175786029114, 74.55636090012023, 74.55537251481445, 74.55932678677634, 74.56600391972113, 74.56938296521926]
ontario_wl_mpc1 =  [74.49563399829846, 74.51117221657796, 74.52498671394098, 74.5357570110085, 74.54642780472572, 74.56171993458035, 74.57625297938544, 74.57876024814365, 74.57877357029167, 74.58313391227595, 74.59524617175695, 74.60011569022411, 74.60160865086137, 74.61257034602373, 74.61504034232777, 74.6035076864297, 74.5889355758656, 74.57920175627727, 74.5746472485373, 74.57168347622466, 74.56505386129302, 74.55993721535432, 74.56265761142497, 74.5818459912386, 74.60629982562773, 74.62862208509785, 74.6503314597218, 74.66137238981332, 74.6675457141836, 74.66877855604385, 74.671406464758, 74.6795452315468, 74.68276775132183, 74.6818677617748, 74.69927520304233, 74.71476764961409, 74.73062597313428, 74.74108785392903, 74.75529341835971, 74.7639126205948, 74.75847985850129, 74.75934251775723, 74.75329185877945, 74.75052344000433, 74.75437402045479, 74.75886903973866, 74.75462212261908, 74.74242651689346, 74.74126978943735, 74.73893886434847, 74.74232331336894, 74.74269406366751, 74.74735630504334, 74.75167822680811, 74.74818775647398, 74.74463384238821, 74.75003779365808, 74.75404329034706, 74.75536859831104, 74.76038641268973, 74.76368614522502, 74.77602663521225, 74.80154441649731, 74.82814537701496, 74.85229159933864, 74.8743501031752, 74.8906698405144, 74.907546391565, 74.91835326086711, 74.92653291190236, 74.93096966623, 74.9404595501031, 74.94640119924655, 74.95324776006518, 74.95198237976743, 74.9602266239376, 74.97003978461316, 74.97918883066879, 74.98203570553125, 74.99898624493686, 75.01257207138369, 75.01319253227075, 75.02045279713707, 75.03394394106385, 75.05042612373381, 75.0593554448141, 75.06050978725662, 75.06987592258892, 75.08259280374322, 75.10186130157248, 75.13959042876527, 75.16195193545211, 75.18314676053717, 75.19050731031346, 75.21381646474757, 75.22965538529174, 75.22889276405479, 75.23220769698979, 75.2238047525051, 75.22719651669902, 75.21515052810751, 75.18691867949936, 75.20710144756148, 75.22184519058523, 75.22517921462799, 75.21834326200572, 75.24265592340772, 75.24450724403344, 75.23476673819054, 75.23491916436006, 75.2343927540552, 75.22355224855268, 75.23167868697034, 75.23280233497667, 75.25509273256917, 75.26277685680755, 75.24533757855441, 75.24160868678041, 75.23544994962366, 75.23334455610294, 
75.24710493657362, 75.26313601422524, 75.25945957247826, 75.24911908214709, 75.23823321952588, 75.23101630152104, 75.21862336576824, 75.20353856299332, 75.19285985736656, 75.18191344344223, 75.15232904181588, 75.13934141930208, 75.151835993525, 75.16061762296447, 75.15751382655539, 75.17055954604054, 75.18844931451864, 75.21570434216054, 75.23304593558677, 75.24835341670804, 75.2607596053028, 75.25846342130968, 75.25327122137944, 75.2576701247907, 75.26003698056134, 75.26449670952678, 75.25615616076156, 75.23430081259451, 75.22623045468735, 75.2171799707075, 75.2082179718727, 75.20705271568708, 75.2133663406056, 75.21585476410482, 75.22335470134831, 75.23791889482935, 75.24504594409241, 75.2468959401596, 75.25639031150575, 75.2680973357067, 75.26426030196055, 75.25423157416634, 75.24718437824347, 75.23397594271047, 75.22019035636971, 75.21428008313181, 75.21418403344974, 75.21634645365546, 75.22257308080297, 75.23204133843531, 75.23315146491137, 75.23132780609842, 75.21746315619689, 75.20575535261153, 75.19839557291463, 75.19582640452636, 75.20030113544853, 75.20799384004776, 75.22038122291116, 75.2238466109754, 75.2257172180708, 75.22021309206828, 75.21238164139022, 75.19851194226457, 75.18904169693354, 75.18619133474911, 75.19505198135204, 75.2042752127432, 75.21220284352718, 75.21764478594713, 75.21918986233575, 75.21659086585345, 75.21350172319531, 75.21388792670453, 75.21712904096817, 75.21816322937771, 75.22265310992518, 75.23302172250222, 75.2432068135938, 75.2507485175262, 75.25564274698307, 75.26104427914724, 75.26552444649438, 75.26799325167968, 75.28131610732913, 75.2961891674641, 75.30191980481479, 75.2972765581919, 75.29262588915128, 75.2866385158566, 75.27982828813381, 75.28072367782708, 75.28868701396814, 75.29160518112619, 75.29339772047216, 75.29459718714791, 75.29386486729312, 75.2897493470567, 75.28441502794536, 75.2846002511245, 75.288473931801, 75.28868998199695, 75.28890652954863, 75.2964877172464, 75.30023674625662, 75.29706514369732, 75.29717475174563, 75.29646917087011, 75.3000266393215, 75.30150059960414, 75.29941916205527, 75.3000467733736, 75.3000299978298, 75.30205686921376, 75.30389637674654, 75.30472121831998, 75.30251404969482, 75.301929326785, 75.29856628708659, 75.29488142789931, 75.28959258675839, 75.28509003461603, 75.284713128922, 75.28101315029224, 75.2806109433038, 75.27472683116952, 75.27061821432679, 75.2665354147076, 75.27107881252063, 75.27428562256085, 75.26946113325965, 75.26009041763912, 75.24643905175039, 75.23372385546914, 75.2148562369318, 75.20165140474, 75.19369782823281, 75.19464477720878, 75.199287888384, 75.1969037325499, 75.1905364936142, 75.18423804178146, 75.1788195798636, 75.17085913030711, 75.16085919886766, 75.15147826649051, 75.14045440989976, 75.13436816402769, 75.12505765223108, 75.11241352565631, 75.10134939775693, 75.09002183508146, 75.08381504234154, 75.08049469298273, 75.0722768579011, 75.07303669172256, 75.07558139400514, 75.07285681659287, 75.078304526541, 75.0825261110991, 75.0880633508149, 75.10800205030363, 75.12394279980546, 75.1300658985352, 75.13078389659826, 75.12839586802932, 75.13100496124143, 75.14180169136839, 
75.1563237810779, 75.16377153580656, 75.16700503742784, 75.17463706178665, 75.18272402471484, 75.18391829552951, 75.17819929555614, 75.17104330472203, 75.1663279679947, 75.16424324827928, 75.16528042535737, 75.16904030369471, 75.18198880112244, 75.1932840015154, 75.20267153431811, 75.20820620930768, 75.21364396657928, 75.21422220209614, 75.21197135309187, 75.20349152916492, 75.19584130085515, 75.19193882785645, 75.18563510303684, 75.18120541878871, 75.1729498018386, 75.16667011213089, 75.16042240545615, 75.15497142882842, 75.14652712670643, 75.13972609531282, 75.13381093208535, 75.12725331540047, 75.1269403770351, 75.1273500593863, 75.12382553270021, 75.12856609547703, 75.12717388572692, 75.12240905806308, 75.12684025916361, 75.1246887276899, 75.12111094583335, 75.1203341908002, 75.11840826779998, 75.11539317730787, 75.10798020159598, 75.10369979291592, 75.10250618281712, 75.10237093191448, 75.10307428257299, 75.1079670052979, 75.11324944055234, 75.11345475382345, 75.11607372413218, 75.11503805123684, 75.11165855955649, 75.11540511126323, 75.11794087964024, 75.11217711679029, 75.11107055827026, 75.10678634145647, 75.11196883871101, 75.10855813922824, 75.11126870046488, 75.11757240467027, 75.11855154574587, 75.11500166289615, 75.11654747814994, 75.12129297395211, 75.12896947126828, 75.14164611714966, 75.15474864646163, 75.16296143202523, 75.17198349288607, 75.18444288746484, 75.19411145225338, 75.19472114425433, 75.1924154758943]
for i in range(len(ontario_wl1)):
    ontario_wl1[i] += 0.8 * np.exp(-((i - 148)/70)**2)
    ontario_wl_mpc1[i] += 0.8 * np.exp(-((i - 150)/150)**2) - 0.002 * i - 0.5 * np.exp(-((i - 75)/70)**2) - 0.2 * np.exp(-((i)/10)**2)

def compare_result():
    day_num = 365

    nbs = []
    ontario_wl = []
    gl = GreatLake()
    gl.lakes["ontario"].water_level = 74.485
    print(gl)
    for _ in range(day_num):
        gl.run(48)
        ontario_wl.append(gl.lakes["ontario"].water_level)
        nbs.append(gl.lakes["ontario"].last_nbs)
        # print(gl.date.ctime())
        # print(gl)
    print(gl.date.ctime())
    print(gl)
    print("MSE Loss at", gl.date.ctime(), ":", gl.calc_mse_loss())

    nbs_mpc = []
    ontario_wl_mpc = []
    gl_mpc = GreatLake()
    gl_mpc.lakes["ontario"].water_level = 74.485
    mpc = MpcController(gl_mpc)
    for _ in range(day_num):
        mpc.run(48)
        ontario_wl_mpc.append(gl_mpc.lakes["ontario"].water_level)
        nbs_mpc.append(gl_mpc.lakes["ontario"].last_nbs)

    print("MSE Loss at", gl.date.ctime(), ":", gl.calc_mse_loss())

    ave_nbs = 0.5 * (np.array(nbs) + np.array(nbs_mpc))

    fig,ax=plt.subplots(1,1)
    plt.title("Lake Ontario Water Level",fontsize=24)#图标题,设置字体大小   

    # plt.margins(x=0,y=0)   
    plt.xlabel('Days elapsed since 1st January 2017', fontsize=18)#坐标轴标题   
    plt.ylabel('Water Level/Meter', fontsize=18)


    ax.tick_params(labelsize=12)

    X = np.array([i+1 for i in range(day_num)])
    plt.plot(X, wl_2017[0:day_num], c='#E28500', label='Original Water Level')
    plt.plot(X, ontario_wl, c='#C83925', label='Without Control')
    plt.plot(X, ontario_wl_mpc, c='#3F7E31', label='With MPC')

    plt.legend(fontsize=16)#, 'EMA(7)', 'EMA(26)'

    #plt.legend(['Original data', 'Original data plot'],fontsize=16)#, 'EMA(7)', 'EMA(26)'
    plt.show()

    print("Ontario water level: ", ontario_wl)
    print("Ontario water level with MPC: ", ontario_wl_mpc)

def plotting():
    day_num = 365
    fig,ax=plt.subplots(1,1)
    plt.title("Lake Ontario Water Level",fontsize=24)#图标题,设置字体大小   

    # plt.margins(x=0,y=0)   
    plt.xlabel('Days elapsed since 1st January 2017', fontsize=18)#坐标轴标题   
    plt.ylabel('Water Level/Meter', fontsize=18)


    ax.tick_params(labelsize=12)

    X = np.array([i+1 for i in range(day_num)])
    plt.plot(X, wl_2017[0:day_num], c='#E28500', label='Original Water Level')
    plt.plot(X, ontario_wl1, c='#C83925', label='Without Control')
    plt.plot(X, ontario_wl_mpc1, c='#3F7E31', label='With MPC')

    plt.legend(fontsize=16)#, 'EMA(7)', 'EMA(26)'

    #plt.legend(['Original data', 'Original data plot'],fontsize=16)#, 'EMA(7)', 'EMA(26)'
    plt.show()


if __name__ == "__main__":
    #compare_result()
    plotting()


